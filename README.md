## [《深入理解 TCP 协议：从原理到实战》](https://s.juejin.cn/ds/DJSYpRU/)

TCP/IP 协议族指的是在 IP 协议通信过程中用到的协议的统称，而非TCP、IP这两种协议


- **应用层**：规定了应用程序之间如何相互传递报文，常见的协议有 HTTP、域名解析协议 DNS和收发邮件的协议 STMP等
- **传输层**：为两台主机之间的 **「应用进程」** 提供**端到端**的逻辑通信，常见的协议有 TCP、UDP协议
- **网络互连层**：**主机到主机的通信**，将传输层产生的的数据包封装成分组数据包发送到目标主机，并提供路由选择的能力。
IP 协议是网络层的主要协议，TCP 和 UDP 都是用 IP 协议作为网络层协议。这一层的主要作用是给包**加上源地址和目标地址**，**将数据包传送到目标地址**
- **网络访问层**：也叫做网络接口层，以太网、Wifi、蓝牙工作在这一层，网络访问层提供了主机连接到物理网络需要的硬件和相关的协议

分层的好处是什么？

1. 各层独立，不需要了解上下层是如何工作的，各层的修改不影响其他层
2. 职责清晰，方便进行标准化

### TCP协议

TCP 是一个**可靠的**（reliable）、**面向连接的**（connection-oriented）、**基于字节流**（byte-stream）的**全双工**（full-duplex）通信协议

可靠性的保证主要有以下几个方面：**校验和**；**包的序列号用来解决数据的乱序和重复**；**超时重传**；**流量控制**；**拥塞控制**

**面向连接**是指在正式发送数据之前需要通过**握手来建立逻辑连接**，而结束通信时，也是**通过有序的四次挥手来断开连接**

基于字节流指的是**没有固定的报文边界**，发送方写入的报文和接收方读取的报文可能不一致，比如说发送方发送500字节和800字节的报文，
而在接收方读取时可能是以1000字节和300字节读取的。这种情况取决于：路径最大传输单元MTU、发送窗口大小和拥塞窗口大小等。

全双工指的是客户端和服务端既可以发送数据也可以接收数据。

#### TCP首部字段

窗口大小默认16位，也就是窗口最大大小为 655535 字节，由于该值太小，便引入了 **TCP窗口缩放** 参数来作为窗口缩放的比例因子，该值范围为 0 - 14，
它是2的指数幂大小，当为0时不进行缩放，下图中抓包信息就没有对窗口值进行缩放。

![img.png](窗口大小.png)

#### 三次握手

![img.png](三次握手.png)

ACK值为期待对侧下次发送报文的SEQ

服务端ACK = 客户端SEQ + 客户端发送的报文长度

SEQ则表示本次当前客户端/服务端发送的序列号

对于客户端而言：

- 初始状态为 `CLOSED`，它并不是一个真实的状态，而是一个假想的起点和终点
- 客户端调用 `connect()` 方法连接服务器后会发送**SYN同步报文**，随后便进入 `SYN-SENT` 状态，客户端将保持这个状态直到收到服务端发送的**ACK确认报文**
- 收到服务端的**ACK确认报文**后，客户端将发送确认收到服务端**SYN同步报文**的ACK确认报文，同时进入 `ESTABLISHED` 状态，表示连接完毕已经可以发送数据了

对于服务端而言：

- 初始状态同样是 `CLOSED`
- 在执行 `bind()` 或 `listen()` 方法后进入 `LISTEN` 状态，等待客户端进行连接
- 当收到客户端的**SYN同步报文**时，会回复**ACK确认报文**和自己的**SYN同步报文**，这是服务器进入 `SYN-RCVD` 状态等待客户端**ACK确认报文**
- 当收到客户端的**ACK确认报文**后，进入 `ESTABLISHED` 状态，可以发送数据了

**SYN同步报文**不携带数据，但是它占用一个序号，**任何凡是消耗TCP序号的报文，都需要对端的ACK确认报文**，如果没有收到确认，会一直重传到指定的次数为止。
在三次握手的过程中，除了交换彼此的初始序列号，还有一些其他辅助信息：MSS（TCP报文最大段大小）、窗口大小、窗口缩放因子和是否支持选择确认等。

注意：初始序列号在生成时是**随机的**，因为这样能够保证安全性，增加伪造报文的难度，还能在开启 `SO_REUSEADDR` 允许端口重用的情况下，
避免因网络延迟产生新旧连接数据报文混淆的问题。

#### MTC 最大传输单元

最大传输单元是指**数据链路层**帧大小限制，不能把太大的包直接塞给链路层传输。所以当一个IP数据包大于MTU时，会将数据进行报文切割，
使得它小于MTU再通过数据链路层进行传输，IP协议头部有一个表示**分片偏移量**的字段来表示该分段在原报文中的位置。一个包从发送端传输到接收端，
中间跨越很多网络，而每条链路上的MTU可能都不一样，整条链路上的MTU由最小的决定（木桶效应）。

执行 `ping -s 3000 www.baidu.com` 来演示报文分割，其中 -s 表示要指定发送数据的字节数

![img.png](MTU报文分割.png)

报文分割的第一个包，`More fragments: Set` 表示这个包是 IP 分段包的一部分，还有其它的分片包，`Fragment offset: 0`表示分片偏移量为 0

![img.png](MTU报文分割2.png)

报文分割的第二个包，`Fragment offset: 1480`，这里表示第一个包的 `payload` 大小

![img.png](MTU报文分割3.png)

报文分割的第三个包，`More fragments: Not set` 表示这个包是最后一个分片，`Fragment offset: 2960` 为偏移量。

由于IP协议是不会对丢包进行重传，只能依赖于传输层TCP协议重传。

#### MSS TCP最大段的大小

TCP为了避免被发送方分片，会主动将数据分割成小段再交给网络层，最大的分段大小成为MSS。`MSS = MTU - IP header头大小 - TCP 头大小`，
在以太网中 MSS = 1500 - 20 - 20 = 1460（无表头选项的情况下），这样就能将一个 MSS 的数据恰好装进一个 MTU 而不用分片了。

### 端口号

分层结构中每一层都有一个唯一标识，比如数据链路层的 MAC 地址，网络互联层的 IP 地址和传输层的端口号。端口号用来区分主机上的应用程序。

### Wireshark 工具

#### 1. 过滤指定域名的包

![img.png](指定域名过滤.png)

执行 `curl http://www.baidu.com`

curl是在命令行下工作的文件传输工具，支持文件的上传和下载

`curl -v www.baidu.com` 会显示通信过程

![img.png](curl-v.png)

#### 异常解决

安装完成后提示 `The capture session could not be initiated on interface 'en0' (You don't have permission to capture on that device).`

执行 `sudo chmod o+r /dev/bpf*` 修改权限即可

### 网络相关命令行操作

- `telnet ip port` 和 `nc -v ip port`: 查看服务器端口是否打开
- `sudo netstat -ltpn | grep :22`: 查看端口被什么进程监听占用